<h1><%= @project.name %></h1>
<h2>
  <%= link_to "Vital", project_path(:id => @project.id) %> 
  <%= link_to "Important", project_path(:id => @project.id, :query => "tagged:important") %> 
  <%= link_to "Nice", project_path(:id => @project.id, :query => "tagged:nice") %> 
  <%= link_to "Anatole", project_path(:id => @project.id, :query => "responsible:anatole") %> 
  <%= link_to "Felix", project_path(:id => @project.id, :query => "responsible:felix") %>
</h2>

<table>
  <tr><td>Title</td><td>Creator</td><td>Assigned To</td></tr>
  <% @tickets.each_with_index do |t, i| %>
    <tr>
      <td><%= check_box_tag t.id, i , false, :class => "chk" %></td>
      <td><%= link_to (title = "##{t.id} #{t.title}"), ticket_url(@project, t), {:target => "_blank"} %></td>
      <td><%= creator =  Lighthouse::User.find(t.creator_id).name %></td>
      <td><%= assigned_user = Lighthouse::User.find(t.assigned_user_id).name %></td>
      <td>
        <% form_tag create_story_path(:id => @project.id) do %>
          <%= hidden_field :story, :name,  :value => title, :id => "name_#{i}" %>
          <%= hidden_field :story, :requested_by, :value => creator, :id => "creator_#{i}"  %>
          <%= hidden_field :story, :owned_by, :value => assigned_user, :id => "assigned_user_#{i}"  %>
          <%= submit_tag "Creat Story" %>
        <% end %>
      </td>
    </tr>
  <% end %>
  <td>
    <a href="javascript:undefined" onclick="$('.chk').attr('checked',true);return false">Select all</a> |
    <a href="javascript:undefined" onclick="$('.chk').attr('checked',false);return false">Unselect all</a>
  </td>
  <td>
    <a href="javascript:undefined" onclick="create_selected_story()">Create Stories</a>
  </td>

<script>
    function create_selected_story() {
      var checkboxes = $('input.chk:checked');
      if (checkboxes.size() === 0) {
        alert('Nothing is selected');
      }
      else if(window.confirm('Are you sure?')){
        var sid = '<%= session[:session_id] %>';
        checkboxes.each(function() {
          var index = this.value.toString();
          var url = '<%= create_story_path(:id => @project.id) %>';
          var data = { sid: sid, "story[name]": $("#name_" + index).val(), "story[requested_by]": $("#creator_" + index).val(), "story[owned_by]": $("#assigned_user_" + index).val()};
          jQuery.post(url, data);
        });
      }
    }
</script>
</table>
